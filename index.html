<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoleHiveX Cortex | Production</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8;
            --bg: #f8fafc; --surface: #ffffff;
            --text-main: #0f172a; --text-sec: #64748b;
            --border: #e2e8f0;
            --success: #10b981; --accent: #8b5cf6;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 80px; }
        
        /* --- LAYOUT --- */
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--surface); border-left: 1px solid var(--border); border-right: 1px solid var(--border); position: relative; }

        /* --- HEADER --- */
        header {
            position: sticky; top: 0; z-index: 50;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
        }
        .nav-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logo { font-weight: 800; font-size: 20px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--primary); }
        .live-badge { font-size: 10px; background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Search Bar */
        .search-wrapper { position: relative; }
        .search-input {
            width: 100%; background: #f1f5f9; border: 1px solid transparent;
            padding: 12px 16px; border-radius: 12px; font-size: 14px; font-weight: 500;
            transition: all 0.2s;
        }
        .search-input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* --- FEED --- */
        #feed { padding: 20px; }
        
        /* --- CARD --- */
        .card {
            background: #fff; border: 1px solid var(--border); border-radius: 16px;
            padding: 20px; margin-bottom: 16px; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); border-color: #cbd5e1; }
        
        /* Suggested Variant */
        .card.suggested { border: 1.5px solid var(--accent); background: #fbfaff; }
        .card.suggested::before {
            content: "‚ú® Smart Match"; position: absolute; top: 0; right: 0;
            background: var(--accent); color: white; font-size: 10px; font-weight: 700;
            padding: 4px 10px; border-bottom-left-radius: 12px;
        }

        /* Card Content */
        .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .match-score { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--primary); background: #eff6ff; padding: 4px 8px; border-radius: 6px; font-weight: 700; display: none; }
        body.debug-mode .match-score { display: block; } /* Show only in debug mode */

        .card h3 { margin: 0; font-size: 17px; font-weight: 600; line-height: 1.4; }
        .card-meta { font-size: 13px; color: var(--text-sec); display: flex; align-items: center; gap: 6px; margin-top: 4px; }
        
        .tags { display: flex; gap: 6px; flex-wrap: wrap; margin: 12px 0; }
        .tag { font-size: 11px; background: #f1f5f9; padding: 4px 10px; border-radius: 6px; color: #475569; font-weight: 600; }
        .tag.highlight { background: #e0e7ff; color: var(--primary); }

        .desc { font-size: 14px; color: #4b5563; line-height: 1.6; margin-bottom: 16px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--text-main); color: white; }
        .btn-primary:hover { background: #000; transform: scale(0.99); }
        .btn-ghost { background: transparent; color: var(--text-sec); border: 1px solid var(--border); margin-top: 8px; }
        .btn-ghost:hover { background: #f8fafc; border-color: #cbd5e1; }

        /* --- SKELETON LOADER --- */
        .skeleton { background: #e2e8f0; border-radius: 4px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .sk-card { border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
        .sk-title { height: 20px; width: 60%; margin-bottom: 10px; }
        .sk-meta { height: 12px; width: 30%; margin-bottom: 20px; }
        .sk-line { height: 12px; width: 100%; margin-bottom: 8px; }

        /* --- TOAST NOTIFICATION --- */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            background: rgba(0,0,0,0.85); color: white; padding: 12px 20px; border-radius: 30px;
            font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); backdrop-filter: blur(4px);
            opacity: 0; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 200; display: none; place-items: center; opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; display: grid; }
        .modal { background: #fff; width: 90%; max-width: 450px; border-radius: 20px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.open .modal { transform: scale(1); }

    </style>
</head>
<body class=""> <div class="app-container">
    <header>
        <div class="nav-row">
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                RoleHiveX <span class="live-badge">Cortex AI</span>
            </div>
            <button onclick="toggleDebug()" style="border:none; background:none; font-size:18px; cursor:pointer;" title="Toggle AI Debug Mode">üêû</button>
        </div>
        <div class="search-wrapper">
            <input type="text" id="searchInput" class="search-input" placeholder="Filter recommendations..." onkeyup="handleSearch()">
        </div>
    </header>

    <div id="feed">
        </div>

    <div id="loading-state">
        <div class="sk-card"><div class="skeleton sk-title"></div><div class="skeleton sk-meta"></div><div class="skeleton sk-line"></div><div class="skeleton sk-line" style="width:80%"></div></div>
        <div class="sk-card"><div class="skeleton sk-title"></div><div class="skeleton sk-meta"></div><div class="skeleton sk-line"></div><div class="skeleton sk-line" style="width:80%"></div></div>
    </div>
</div>

<div id="toast-container"></div>

<div id="detailModal" class="modal-overlay">
    <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
            <h2 id="m-title" style="margin:0; font-size:20px;"></h2>
            <button onclick="closeModal()" style="border:none; background:#f1f5f9; width:30px; height:30px; border-radius:50%; cursor:pointer;">&times;</button>
        </div>
        <div id="m-tags" class="tags"></div>
        <p id="m-desc" style="line-height:1.6; color:#333; font-size:15px;"></p>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; font-size:12px; color:#999;">
            AI Reference ID: <span id="m-id" style="font-family:monospace;"></span>
        </div>
        <button class="btn btn-primary" style="margin-top:15px;" onclick="closeModal(); showToast('Application Started üöÄ')">Apply Now</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    const API_URL = "http://127.0.0.1:8000";
    const USER_ID = "user_1";
    
    // State
    let feedData = [];
    let seenIds = new Set();
    let observer;
    let dwellTimers = {};

    // --- 1. INITIALIZATION ---
    async function init() {
        // Wait 800ms just to show off the skeleton loader (UX Best Practice)
        await new Promise(r => setTimeout(r, 800));
        
        try {
            const res = await fetch(`${API_URL}/feed/${USER_ID}`);
            if(!res.ok) throw new Error("API Offline");
            
            const jobs = await res.json();
            feedData = jobs;
            
            document.getElementById('loading-state').style.display = 'none';
            renderFeed(jobs);
            initObserver();
        } catch (e) {
            document.getElementById('feed').innerHTML = `<div style="text-align:center; padding:40px; color:#ef4444;">‚ùå <b>System Offline</b><br>Is the Cortex server running?</div>`;
            document.getElementById('loading-state').style.display = 'none';
        }
    }

    // --- 2. RENDERING ---
    function renderFeed(jobs, append = false) {
        const container = document.getElementById('feed');
        if (!append) container.innerHTML = ''; // Clear if full render

        jobs.forEach(job => {
            if (seenIds.has(job.id)) return;
            
            const card = createCardEl(job);
            container.appendChild(card);
            seenIds.add(job.id);
            if(observer) observer.observe(card);
        });
    }

    function createCardEl(job, type="normal") {
        const div = document.createElement('div');
        div.className = `card ${type}`;
        div.dataset.id = job.id;
        
        // Debug Score (Random for demo if not provided by backend)
        const score = job.score ? Math.round(job.score * 100) : Math.floor(Math.random() * 40 + 60);

        div.innerHTML = `
            <div class="card-header">
                <span class="match-score">üéØ ${score}% Match</span>
            </div>
            <h3>${job.title}</h3>
            <div class="card-meta">
                <span>üìç ${job.location}</span> &bull; <span>3d ago</span>
            </div>
            <div class="tags">
                ${job.tags.slice(0,3).map(t => `<span class="tag ${t === 'React' || t === 'Node.js' ? 'highlight' : ''}">${t}</span>`).join('')}
            </div>
            <div class="desc">${job.description}</div>
            <button class="btn btn-primary" onclick='openModal(${JSON.stringify(job)})'>
                View Details
            </button>
            <button class="btn btn-ghost" onclick="triggerAction('${job.id}', 'bookmark')">
                Save for Later
            </button>
        `;
        return div;
    }

    // --- 3. LOGIC & EVENTS ---
    
    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = feedData.filter(j => 
            j.title.toLowerCase().includes(term) || 
            j.tags.some(t => t.toLowerCase().includes(term))
        );
        
        // Reset seen IDs so we can re-render filtered items
        seenIds.clear(); 
        renderFeed(filtered);
    }

    async function triggerAction(jobId, action) {
        if(action === 'bookmark') showToast("Saved to Collections üìå");
        
        // 1. Send Event
        await fetch(`${API_URL}/track/event`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: USER_ID, job_id: jobId, action_type: action })
        });

        // 2. If it's a strong signal, fetch immediate Recommendations
        if (action === 'dwell_15s' || action === 'expand') {
            fetchSimilar(jobId);
        }
    }

    async function fetchSimilar(triggerId) {
        try {
            const res = await fetch(`${API_URL}/jobs/similar/${triggerId}`);
            const similarJobs = await res.json();
            
            const bestMatch = similarJobs.find(j => !seenIds.has(j.id));
            if (bestMatch) {
                injectCard(bestMatch, triggerId);
            }
        } catch(e) { console.log("AI Busy"); }
    }

    function injectCard(job, triggerId) {
        const feed = document.getElementById('feed');
        const triggerCard = document.querySelector(`.card[data-id="${triggerId}"]`);
        
        const newCard = createCardEl(job, "suggested");
        
        if (triggerCard && triggerCard.nextSibling) {
            feed.insertBefore(newCard, triggerCard.nextSibling);
        } else {
            feed.appendChild(newCard);
        }
        
        showToast("‚ú® New Recommendation Found");
        
        if(observer) observer.observe(newCard);
        seenIds.add(job.id);
    }

    // --- 4. OBSERVER (Eye Tracker) ---
    function initObserver() {
        observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const id = entry.target.dataset.id;
                if (entry.isIntersecting) {
                    dwellTimers[id] = setTimeout(() => {
                        triggerAction(id, 'dwell_15s');
                        // Visual feedback (Debug only)
                        entry.target.style.borderColor = "#2563eb"; 
                    }, 2500);
                } else {
                    clearTimeout(dwellTimers[id]);
                }
            });
        }, { threshold: 0.65 });

        document.querySelectorAll('.card').forEach(c => observer.observe(c));
    }

    // --- 5. UI UTILS ---
    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = 'toast';
        el.innerHTML = `<span>${msg}</span>`;
        container.appendChild(el);
        
        // Animate in
        requestAnimationFrame(() => el.classList.add('show'));
        
        // Remove after 3s
        setTimeout(() => {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    }

    function openModal(job) {
        const modal = document.getElementById('detailModal');
        document.getElementById('m-title').innerText = job.title;
        document.getElementById('m-desc').innerText = job.description;
        document.getElementById('m-id').innerText = job.id;
        document.getElementById('m-tags').innerHTML = job.tags.map(t => `<span class="tag">${t}</span>`).join('');
        
        modal.classList.add('open');
        triggerAction(job.id, 'expand'); // This counts as an "Open" event
    }

    function closeModal() {
        document.getElementById('detailModal').classList.remove('open');
    }

    function toggleDebug() {
        document.body.classList.toggle('debug-mode');
        showToast("Debug Mode Toggled üõ†Ô∏è");
    }

    // Start
    init();

</script>
</body>
</html>